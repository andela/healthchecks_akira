machine:
    python:
        version: 3.5.2
dependencies:
    pre:
        - pip install -r requirements.txt
        - pip install mock

database:
  override:
    - psql -u ubuntu circle_test < hc-setup.psql

test:
    override:
        - psql --user postgres 
            postgres=# create database hc;
        - python manage.py migrate
        - python manage.py collectstatic --noinput --settings=hc.settings
        - python manage.py compress
        - python manage.py test

deployment:
  staging:
    branch: develop
    commands:
      - git fetch origin --unshallow
      - git push -f git@heroku.com:healthchecks-akira.git $CIRCLE_SHA1:master
      - heroku run python manage.py collectstatic --noinput --settings=hc.settings --app healthchecks-akira
      - heroku run python manage.py makemigrations --settings=hc.settings --app healthchecks-akira
      - heroku run python manage.py migrate auth --noinput --settings=hc.settings --app healthchecks-akira
      - heroku run python manage.py migrate --settings=hc.settings --app healthchecks-akira
      - heroku run python manage.py syncdb --noinput --settings=hc.settings --app healthchecks-akira
      - heroku ps:scale web=1 --app healthchecks-akira
